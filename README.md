`terraform-consul-genconfig` is a slightly-opinionated tool for producing
[Terraform](https://terraform.io/) configurations that write data into
a [Consul](https://consul.io/) key-value store based on values from a set
of YAML files.

It expects (and requires) a particular approach to organizing configuration
in Consul:

* You have multiple applications with different names, and you'll group each
  application's configuration under a path that includes the application's
  name.
* Each datacenter has a separate set of configuration values, but the key
  naming scheme is the same in each datacenter.
* Optionally, you have a particular sub-tree of Consul that is replicated
  across all of your datacenters using a tool like
  [consul-replicate](https://github.com/hashicorp/consul-replicate). This
  part of the store uses a similar structure to the local values, with
  configurations grouped by application, but has a different key structure
  and is represented in this tool as a "pseudo-datacenter" called "global".

As a more concrete example, consider that you have two applications called
"foo" and "baz" and two Consul datacenters called "us-east" and "us-west".
Each application has a set of configuration values for each datacenter,
and a special *global* configuration which gets written to the default
datacenter and replicated to the others.

In this situation, you might run this tool as follows:

```
terraform-consul-genconfig -key-prefix="local/{{.AppName}}" -global-key-prefix="global/{{.AppName}}" ./config ./tf-config
```

Inside the directory "config" you'd have a directory structure looking like
this:

```
- foo
  - us-east.yml
  - us-west.yml
  - global.yml
- baz
  - us-east.yml
  - us-west.yml
  - global.yml
```

This tool would then read each of the YAML files and create a set of Terraform
configuration files in `./tf-config` that include `consul_keys` resources to
write the data within these files to suitable locations within the Consul
store. You'd just need to augment that generated config with a
suitable `provider "consul"` block, and use Terraform to apply it.

Global Configuration
--------------------

If the `-global-key-prefix` option is provided, the datacenter name "global"
is treated as a special case. Data from the `global.yml` file in each app's
directory will produce Consul keys based on the provided template and
*no explicit datacenter*.

The configuration generated by this mechanism thus makes two assumptions
about your configuration:

* You are running [consul-replicate](https://github.com/hashicorp/consul-replicate),
  or some equivalent tool, to copy the keys written under the global key
  prefix to all datacenters.

* Terraform's `consul` provider is configured to talk to a server in whatever
  datacenter is the "primary" for replication purposes.

Contributing
------------

This tool primarily exists in support of the configuration management practices
at Say Media, and it makes assumptions that may not be true of all
environments.

Contributions that allow customization of these assumptions will be considered
but may not be accepted into this repository in order to keep this tool
simple and maintainable. However, you are welcome to fork this tool and
customize it for your own purposes.

License
-------

The MIT License (MIT)

Copyright (c) 2016 Say Media, Inc.

Permission is hereby granted, free of charge, to any person obtaining a copy
of this software and associated documentation files (the "Software"), to deal
in the Software without restriction, including without limitation the rights
to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
copies of the Software, and to permit persons to whom the Software is
furnished to do so, subject to the following conditions:

The above copyright notice and this permission notice shall be included in all
copies or substantial portions of the Software.

THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
SOFTWARE.
